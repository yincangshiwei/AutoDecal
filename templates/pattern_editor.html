<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title data-i18n="page-title">3D环绕贴图编辑器</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.loli.net/css?family=Noto+Sans+SC:400,500,700&display=swap" rel="stylesheet">
  <link id="themeStylesheet" rel="stylesheet" href="{{ url_for('static', filename='themes/default.css') }}">
  <style>
    body {
      font-family: 'Noto Sans SC', sans-serif;
      background: #0f172a;
      min-height: 100vh;
      color: #e2e8f0;
      margin: 0;
      padding: 0;
      /* 防止整个页面在触摸时被拖动 */
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }
    .editor-container {
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      background: rgba(26, 32, 44, 0.8);
      border-radius: 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      height: 100vh;
    }
    .control-panel {
      background: linear-gradient(to right, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-gradient {
      background: linear-gradient(to right, #6366f1 0%, #8b5cf6 100%);
      color: white;
      transition: all 0.3s ease;
    }
    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
    }
    .slider-thumb::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #6366f1;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .canvas-container {
      background: linear-gradient(45deg, #1e293b 25%, transparent 25%) -50px 0,
                  linear-gradient(-45deg, #1e293b 25%, transparent 25%) -50px 0,
                  linear-gradient(45deg, transparent 75%, #1e293b 75%),
                  linear-gradient(-45deg, transparent 75%, #1e293b 75%);
      background-size: 100px 100px;
      /* 防止触摸时页面滚动 */
      touch-action: none;
      overflow: hidden;
    }
    .pattern-list, .product-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .pattern-item, .product-item {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .pattern-item:hover, .product-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(99, 102, 241, 0.2);
    }
    .pattern-item.active, .product-item.active {
      border: 2px solid #6366f1;
    }
    .blend-mode-select {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      border-radius: 6px;
      padding: 0.5rem;
    }
    .category-select {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      border-radius: 6px;
      padding: 0.5rem;
      width: 100%;
      transition: all 0.3s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23e2e8f0' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
    }
    .category-select:hover {
      border-color: rgba(99, 102, 241, 0.5);
    }
    .category-select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
    }
    .theme-select {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      border-radius: 6px;
      min-width: 120px;
      transition: all 0.3s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23e2e8f0' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 16px 12px;
    }
    .theme-select:hover {
      border-color: rgba(99, 102, 241, 0.5);
    }
    .theme-select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
    }
    @media (max-width: 1024px) and (min-width: 769px) {
      /* iPad样式 */
      .pattern-list {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      .preview-panel {
        max-width: 400px !important;
      }
      .canvas-container {
        width: 400px !important;
        height: 400px !important;
      }
    }
    @media (max-width: 768px) {
      .editor-layout {
        flex-direction: column;
      }
      .pattern-panel, .preview-panel, .product-panel {
        width: 100% !important;
        max-width: 100% !important;
      }
      .pattern-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    /* 主题设置弹窗样式（配合 default.css 变量） */
    .theme-modal { 
      background: var(--holiday-surface, #ffffff);
      color: var(--text-primary, #0f172a);
      border: 1px solid var(--border-color, #e5e7eb);
      box-shadow: var(--shadow, 0 12px 24px rgba(15, 23, 42, 0.08));
      border-radius: 12px;
      width: 400px;
    }
    .theme-modal-backdrop {
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(2px);
    }
    .theme-modal-close {
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border: 1px solid var(--border-color, #e5e7eb);
      color: var(--text-primary, #0f172a);
      width: 32px;
      height: 32px;
      border-radius: 9999px;
      line-height: 30px;
      text-align: center;
    }
    /* 弹窗内增强滑块尺寸（仅作用于主题设置） */
    .theme-modal .modal-slider { width: 100%; }
    .theme-modal .modal-slider::-webkit-slider-runnable-track {
      height: 12px;
      background: linear-gradient(90deg, #eef2f7, #ffffff);
      border-radius: 999px;
      border: 1px solid var(--border-color, #e5e7eb);
      box-shadow: inset 2px 2px 4px rgba(15,23,42,0.06), inset -2px -2px 4px rgba(255,255,255,0.8);
    }
    .theme-modal .modal-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #fecaca 60%, #dc2626 100%);
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.12), 0 8px 14px rgba(15,23,42,0.18);
      margin-top: -9px; /* 居中在 12px 轨道上 */
      cursor: pointer;
    }
    .theme-modal .modal-slider::-moz-range-track {
      height: 12px;
      background: linear-gradient(90deg, #eef2f7, #ffffff);
      border-radius: 999px;
      border: 1px solid var(--border-color, #e5e7eb);
      box-shadow: inset 2px 2px 4px rgba(15,23,42,0.06), inset -2px -2px 4px rgba(255,255,255,0.8);
    }
    .theme-modal .modal-slider::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #fecaca 60%, #dc2626 100%);
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.12), 0 8px 14px rgba(15,23,42,0.18);
      cursor: pointer;
    }
  </style>
</head>
<body class="py-0 px-0">
  <div class="editor-container p-6">
    <!-- 语言切换按钮 -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-4xl font-bold text-white" data-i18n="title">3D环绕贴图编辑器</h1>
      <div class="flex items-center gap-2">
        <button id="themeSettingsBtn" class="px-3 py-1 rounded-md bg-gray-700 text-white hover:bg-gray-600 transition text-sm" data-i18n="theme-settings">主题设置</button>
        <button id="langBtn" class="px-3 py-1 rounded-md bg-gray-700 text-white hover:bg-gray-600 transition text-sm">
          EN
        </button>
      </div>
    </div>
    
    <div class="editor-layout flex flex-wrap gap-6 mb-6">
      <!-- 左侧贴图列表 -->
      <div class="pattern-panel w-1/4 min-w-[250px]">
        <h2 class="text-xl font-semibold mb-4 text-white" data-i18n="patterns">贴图图案</h2>
        <div class="pattern-list-wrap">
          <div class="pattern-list grid grid-cols-3 gap-3 p-3 bg-gray-800 rounded-lg">
          </div>
        </div>
      </div>

      <!-- 中间预览区域 -->
      <div class="preview-panel flex-1 min-w-[400px] max-w-[450px]">
        <h2 class="text-xl font-semibold mb-4 text-white" data-i18n="preview">效果预览</h2>
        <div class="relative border-2 border-gray-700 rounded-lg overflow-hidden canvas-container mx-auto" style="width: 450px; height: 450px;">
          <canvas id="editorCanvas" class="absolute inset-0 w-full h-full"></canvas>
          <div id="canvasPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-400" data-i18n="placeholder">
            请选择贴图和产品图开始编辑
          </div>
        </div>
      </div>

      <!-- 右侧产品图列表 -->
      <div class="product-panel w-1/5 min-w-[200px]">
        <h2 class="text-xl font-semibold mb-4 text-white" data-i18n="products">产品图</h2>
        <select id="categorySelect" class="category-select mb-4">
          <option value="all" data-i18n="all-products">全部产品</option>
        </select>
        <div class="product-list-wrap">
          <div class="product-list space-y-3 p-3 bg-gray-800 rounded-lg">
          </div>
        </div>
      </div>
    </div>

    <!-- 下方控制区域 -->
    <div class="control-panel p-6">
      <h2 class="text-xl font-semibold mb-4 text-white" data-i18n="controls">图案参数控制</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1" data-i18n="distortion">形变强度 (0.300)</label>
          <input type="range" id="distortion" min="0" max="1" step="0.001" value="0.300" class="w-full slider-thumb">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1" data-i18n="opacity">透明度 (1.000)</label>
          <input type="range" id="opacity" min="0" max="1" step="0.001" value="1.000" class="w-full slider-thumb">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1" data-i18n="skew-x">水平倾斜 (0.000)</label>
          <input type="range" id="skewX" min="-1" max="1" step="0.001" value="0.000" class="w-full slider-thumb">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1" data-i18n="skew-y">垂直倾斜 (0.000)</label>
          <input type="range" id="skewY" min="-1" max="1" step="0.001" value="0.000" class="w-full slider-thumb">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1" data-i18n="blend-mode">混合模式</label>
          <select id="blendMode" class="blend-mode-select w-full">
            <option value="normal">Normal</option>
            <option value="multiply">Multiply</option>
            <option value="screen">Screen</option>
            <option value="overlay">Overlay</option>
            <option value="darken">Darken</option>
            <option value="lighten">Lighten</option>
            <option value="color-dodge">Color Dodge</option>
            <option value="color-burn">Color Burn</option>
            <option value="soft-light">Soft Light</option>
            <option value="hard-light">Hard Light</option>
            <option value="hologram">Hologram</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1" data-i18n="depth-threshold">深度阈值 (0.700)</label>
          <input type="range" id="depthThreshold" min="0" max="1" step="0.001" value="0.700" class="w-full slider-thumb">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1" data-i18n="perspective">透视强度 (0.000)</label>
          <input type="range" id="perspective" min="0" max="2" step="0.001" value="0.000" class="w-full slider-thumb">
        </div>
      </div>

      <div class="flex flex-wrap justify-between items-center gap-4 mt-6">
        <div class="flex gap-4">
          <button id="resetBtn" class="px-4 py-2 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 transition" data-i18n="reset">重置</button>
          <button id="exportBtn" class="px-4 py-2 rounded-md btn-gradient" data-i18n="export">导出图片</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 主题设置弹窗 -->
  <div id="themeSettingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="theme-modal-backdrop absolute inset-0"></div>
    <div class="theme-modal relative z-10 max-w-lg w-[90%] rounded-xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold" data-i18n="theme-settings-title">主题设置</h3>
        <button id="themeSettingsClose" class="theme-modal-close" aria-label="Close">×</button>
      </div>
      <div class="space-y-4">
        <div class="space-y-2">
          <label class="text-sm font-medium" data-i18n="theme">主题:</label>
          <select id="themeSelect" class="theme-select px-3 py-2 rounded-md w-full">
            <option value="default" data-i18n="theme-default">默认主题</option>
            <option value="christmas" data-i18n="theme-christmas">圣诞主题</option>
            <option value="halloween" data-i18n="theme-halloween">万圣节主题</option>
            <option value="easter" data-i18n="theme-easter">复活节主题</option>
            <option value="spring-festival" data-i18n="theme-spring-festival">春节主题</option>
          </select>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium" data-i18n="background">背景图:</label>
          <select id="bgSelect" class="theme-select px-3 py-2 rounded-md w-full">
            <option value="" data-i18n="default">默认</option>
          </select>
        </div>
        <!-- 上层透明度控件 -->
        <div class="space-y-2">
          <label id="bgOpacityTopLabel" class="text-sm font-medium" data-i18n="upper-opacity">上层透明度 (0.30)</label>
          <input type="range" id="bgOpacityTop" min="0" max="1" step="0.01" value="0.3" class="w-full slider-thumb modal-slider">
        </div>
        <!-- 下层透明度控件 -->
        <div class="space-y-2">
          <label id="bgOpacityBottomLabel" class="text-sm font-medium" data-i18n="lower-opacity">下层透明度 (0.30)</label>
          <input type="range" id="bgOpacityBottom" min="0" max="1" step="0.01" value="0.3" class="w-full slider-thumb modal-slider">
        </div>
      </div>
    </div>
  </div>

  <div id="preload-images" style="display:none;">
    <!-- 动态加载的图片将在这里预加载 -->
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // 多语言配置 - 暴露给全局作用域
    window.translations = {
      'zh-CN': {
        'page-title': '3D环绕贴图编辑器',
        'title': '3D环绕贴图编辑器',
        'patterns': '贴图图案',
        'preview': '效果预览',
        'products': '产品图',
        'all-products': '全部产品',
        'controls': '图案参数控制',
        'distortion': '形变强度',
        'opacity': '透明度',
        'skew-x': '水平倾斜',
        'skew-y': '垂直倾斜',
        'blend-mode': '混合模式',
        'depth-threshold': '深度阈值',
        'perspective': '透视强度',
        'reset': '重置',
        'export': '导出图片',
        'theme': '主题:',
        'background': '背景图:',
        'default': '默认',
        'theme-default': '默认主题',
        'theme-christmas': '圣诞主题',
        'theme-halloween': '万圣节主题',
        'theme-easter': '复活节主题',
        'theme-spring-festival': '春节主题',
        'placeholder': '请选择贴图和产品图开始编辑',
        'theme-settings': '主题设置',
        'theme-settings-title': '主题设置',
        'upper-opacity': '上层透明度',
        'lower-opacity': '下层透明度'
      },
      'en': {
        'page-title': '3D Wrap Texture Editor',
        'title': '3D Wrap Texture Editor',
        'patterns': 'Patterns',
        'preview': 'Preview',
        'products': 'Products',
        'all-products': 'All Products',
        'controls': 'Pattern Controls',
        'distortion': 'Distortion',
        'opacity': 'Opacity',
        'skew-x': 'Horizontal Skew',
        'skew-y': 'Vertical Skew',
        'blend-mode': 'Blend Mode',
        'depth-threshold': 'Depth Threshold',
        'perspective': 'Perspective',
        'reset': 'Reset',
        'export': 'Export Image',
        'theme': 'Theme:',
        'background': 'Background:',
        'default': 'Default',
        'theme-default': 'Default Theme',
        'theme-christmas': 'Christmas Theme',
        'theme-halloween': 'Halloween Theme',
        'theme-easter': 'Easter Theme',
        'theme-spring-festival': 'Spring Festival Theme',
        'placeholder': 'Please select pattern and product to start editing',
        'theme-settings': 'Theme Settings',
        'theme-settings-title': 'Theme Settings',
        'upper-opacity': 'Upper Opacity',
        'lower-opacity': 'Lower Opacity'
      }
    };

    // 语言切换功能
    let currentLang = localStorage.getItem('language') || 'zh-CN';
    
    function updateLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('language', lang);
      
      // 更新HTML lang属性
      document.documentElement.lang = lang;
      
      // 更新页面标题
      document.title = translations[lang]['page-title'];
      
      // 更新所有带有data-i18n属性的元素
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[lang][key]) {
          // 对于包含数值的标签，保留数值部分
          if (element.tagName === 'LABEL' && element.textContent.includes('(')) {
            const match = element.textContent.match(/\(([\d.]+)\)/);
            const value = match ? match[1] : '';
            element.textContent = translations[lang][key] + (value ? ` (${value})` : '');
          } else {
            element.textContent = translations[lang][key];
          }
        }
      });
      
      // 延迟调用透明度标签更新，确保JS文件已加载
      setTimeout(() => {
        if (window.updateBgOpacityLabels) {
          window.updateBgOpacityLabels();
        }
      }, 100);
      
      // 更新语言按钮文本
      const langBtn = document.getElementById('langBtn');
      if (langBtn) {
        langBtn.textContent = lang === 'zh-CN' ? 'EN' : '中文';
      }
    }

    // 初始化语言
    document.addEventListener('DOMContentLoaded', function() {
      updateLanguage(currentLang);
      
      // 语言切换按钮事件
      const langBtn = document.getElementById('langBtn');
      if (langBtn) {
        langBtn.addEventListener('click', function() {
          const newLang = currentLang === 'zh-CN' ? 'en' : 'zh-CN';
          updateLanguage(newLang);
        });
      }

      // 主题设置弹窗开关
      const themeBtn = document.getElementById('themeSettingsBtn');
      const modal = document.getElementById('themeSettingsModal');
      const closeBtn = document.getElementById('themeSettingsClose');
      const backdrop = modal ? modal.querySelector('.theme-modal-backdrop') : null;
      if (themeBtn && modal) {
        themeBtn.addEventListener('click', () => { modal.classList.remove('hidden'); });
      }
      if (closeBtn && modal) {
        closeBtn.addEventListener('click', () => { modal.classList.add('hidden'); });
      }
      if (backdrop && modal) {
        backdrop.addEventListener('click', () => { modal.classList.add('hidden'); });
      }
    });
  </script>
  <script src="{{ url_for('static', filename='js/pattern_editor.js') }}"></script>
</body>
</html>