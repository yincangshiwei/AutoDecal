# 授权码访问管理功能说明

## 功能概述

授权码访问管理功能用于记录和管理通过授权码登录系统的用户访问情况，提供详细的访问记录查看和管理功能。

## 主要功能

### 1. 访问记录自动记录
- **会话编号**: 每次登录生成唯一的会话ID
- **主机信息**: 记录用户的IP地址
- **地理位置**: 记录登录地点（可扩展集成IP地理位置API）
- **浏览器信息**: 自动识别用户使用的浏览器类型和版本
- **操作系统**: 自动识别用户的操作系统
- **时间记录**: 记录登录时间、最后活动时间、登出时间

### 2. 访问记录管理界面
- **记录列表**: 显示所有访问记录的详细信息
- **状态显示**: 区分在线和离线用户
- **筛选功能**: 支持按状态、授权码筛选
- **搜索功能**: 支持按IP、地点、浏览器等关键词搜索
- **统计信息**: 显示总访问次数、在线用户数、使用的授权码数量、今日访问量

### 3. 强制登出功能
- **在线用户管理**: 可以强制登出指定的在线用户
- **会话管理**: 支持查看和管理用户会话

## 技术实现

### 1. 数据库表结构
```sql
CREATE TABLE access_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,           -- 会话编号
    access_code TEXT NOT NULL,          -- 使用的授权码
    ip_address TEXT,                    -- IP地址
    location TEXT,                      -- 登录地点
    browser TEXT,                       -- 浏览器信息
    operating_system TEXT,              -- 操作系统
    login_time DATETIME DEFAULT CURRENT_TIMESTAMP,     -- 登录时间
    last_activity DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 最后活动时间
    is_active BOOLEAN DEFAULT 1,        -- 是否在线
    logout_time DATETIME,               -- 登出时间
    FOREIGN KEY (access_code) REFERENCES access_codes (code)
);
```

### 2. 核心功能模块

#### 访问记录创建 (app.py)
- 在用户通过授权码验证时自动创建访问记录
- 使用user-agents库解析浏览器和操作系统信息
- 生成唯一的会话ID

#### 活动时间更新
- 通过Flask中间件在每次请求时更新用户活动时间
- 保持用户在线状态的准确性

#### 访问记录管理 (admin_app.py)
- 提供完整的访问记录CRUD操作
- 支持强制登出功能
- 提供统计数据接口

### 3. 前端界面特性
- 响应式设计，支持移动端访问
- 实时数据更新（每30秒自动刷新）
- 交互式筛选和搜索
- 美观的统计卡片展示

## 使用方法

### 1. 访问后台管理
1. 启动后台管理应用：`python admin_app.py`
2. 访问 http://localhost:7860
3. 使用管理员账号登录（admin/admin123）

### 2. 查看访问记录
1. 在左侧导航菜单中点击"访问记录管理"
2. 查看所有用户的访问记录
3. 使用筛选和搜索功能定位特定记录

### 3. 管理在线用户
1. 在访问记录列表中查看在线用户（绿色状态）
2. 点击"强退"按钮可以强制用户下线
3. 查看统计信息了解系统使用情况

### 4. 前台用户访问
1. 启动前台应用：`python app.py`
2. 访问 http://localhost:5000
3. 使用授权码登录（如：TEST2024）
4. 系统自动记录访问信息

## 扩展功能

### 1. IP地理位置
可以集成第三方IP地理位置API来获取更准确的地理位置信息：
- 百度地图API
- 高德地图API
- IP138等服务

### 2. 访问统计报表
- 按时间段统计访问量
- 按地区统计用户分布
- 按设备类型统计使用情况

### 3. 安全监控
- 异常登录检测
- 多地登录提醒
- 访问频率监控

## 安全考虑

1. **会话管理**: 使用UUID生成唯一会话ID
2. **数据保护**: 敏感信息适当脱敏显示
3. **权限控制**: 只有管理员可以查看和管理访问记录
4. **日志清理**: 可以定期清理过期的访问记录

## 注意事项

1. 确保安装了`user-agents`库：`pip install user-agents`
2. 访问记录会占用数据库空间，建议定期清理
3. 强制登出功能会立即终止用户会话
4. 页面会每30秒自动刷新以更新在线状态

这个功能为系统管理员提供了完整的用户访问监控和管理能力，有助于了解系统使用情况和保障系统安全。