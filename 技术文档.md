# 产品印花平台技术文档

## 项目概述

产品印花平台是一个基于Flask和Gradio的Web应用系统，主要用于产品印花设计和管理。系统分为前台用户界面和后台管理界面两个部分，支持印花图案上传、产品管理、授权码访问控制等功能。

## 系统架构

### 整体架构
```
产品印花平台
├── 前台系统 (Flask) - 端口5000
│   ├── 印花设计编辑器
│   ├── 授权码验证
│   └── 用户会话管理
└── 后台管理系统 (Gradio) - 端口7860
    ├── 印花图案管理
    ├── 产品管理
    ├── 授权码管理
    └── 用户权限管理
```

### 技术栈
- **后端框架**: Flask + Gradio
- **数据库**: SQLite
- **前端技术**: HTML5 + CSS3 + JavaScript
- **图像处理**: PIL (Python Imaging Library)
- **认证系统**: 自定义授权码 + 用户权限管理

## 目录结构

```
AutoDecal/
├── app.py                          # 前台Flask应用主入口
├── admin_app.py                    # 后台Gradio管理界面入口
├── database.db                     # SQLite数据库文件
├── requirements.txt                # Python依赖包
├── 授权码访问管理功能说明.md        # 授权码功能说明
│
├── backend/                        # 后端核心模块
│   ├── __init__.py
│   ├── admin_methods.py            # 管理员操作方法
│   ├── auth.py                     # 认证和授权管理
│   ├── database.py                 # 数据库操作封装
│   ├── flask_admin.py              # Flask管理界面
│   ├── flask_admin_extended.py     # 扩展管理功能
│   ├── gradio_admin.py             # Gradio管理界面
│   ├── models.py                   # 数据模型定义
│   ├── product_manager.py          # 产品管理器
│
├── frontend/                       # 前端API模块
│   ├── __init__.py
│   └── api.py                      # 前端API接口
│
├── static/                         # 静态资源
│   ├── admin/css/                  # 管理界面样式
│   ├── css/                        # 前台样式文件
│   ├── images/                     # 图片资源
│   ├── js/                         # JavaScript文件
│   └── themes/                     # 主题样式文件
│
├── templates/                      # 模板文件
│   ├── admin/                      # 管理界面模板
│   ├── access_login.html           # 授权码登录页面
│   └── pattern_editor.html         # 印花编辑器页面
│
└── uploads/                        # 上传文件存储
    ├── patterns/                   # 印花图案文件
    ├── products/                   # 产品图片文件
    └── depth_maps/                 # 深度图文件
```

## 核心模块详解

### 1. 应用入口模块

#### app.py - 前台Flask应用
- **功能**: 前台用户界面主入口
- **端口**: 5000
- **主要路由**:
  - `/` - 首页，重定向到印花编辑器
  - `/pattern-editor` - 印花图案编辑器
  - `/access-login` - 授权码登录页面
  - `/verify-access-code` - 授权码验证接口
  - `/logout` - 用户登出
  - `/uploads/<filename>` - 文件访问接口

#### admin_app.py - 后台管理应用
- **功能**: 后台管理界面入口
- **端口**: 7860
- **基于**: Gradio框架
- **管理功能**: 印花图案、产品、用户、授权码等

### 2. 后端核心模块

#### backend/database.py - 数据库管理
```python
class DatabaseManager:
    # 数据库连接和操作封装
    - execute_query()      # 执行查询
    - execute_insert()     # 执行插入
    - execute_update()     # 执行更新
    - get_patterns()       # 获取印花图案
    - add_pattern()        # 添加印花图案
    - delete_pattern()     # 删除印花图案
```

#### backend/auth.py - 认证授权系统
```python
class AuthManager:
    - authenticate_user()  # 用户认证
    - create_user()        # 创建用户
    - hash_password()      # 密码哈希

class AccessCodeManager:
    - verify_access_code() # 验证授权码
    - create_access_code() # 创建授权码
    - get_access_codes()   # 获取授权码列表
```

#### backend/models.py - 数据模型
```python
class Pattern:           # 印花图案模型
class Product:           # 产品模型
class ProductCategory:   # 产品分类模型
class User:             # 用户模型
class AccessCode:       # 授权码模型
```

#### backend/gradio_admin.py - Gradio管理界面
```python
class GradioAdmin:
    - authenticate()       # 管理员认证
    - get_patterns_list()  # 获取图案列表
    - add_pattern()        # 添加图案
    - delete_pattern()     # 删除图案
    - clear_patterns()     # 清空图案
```

### 3. 前端模块

#### frontend/api.py - API接口
- 提供前台所需的REST API接口
- 处理图案上传、产品管理等业务逻辑
- 返回JSON格式数据

#### static/js/ - JavaScript文件
- `pattern_editor.js` - 印花编辑器核心逻辑
- `frontend.js` - 前台通用功能
- `utils.js` - 工具函数

## 数据库设计

### 主要数据表

#### patterns - 印花图案表
```sql
CREATE TABLE patterns (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    filename TEXT NOT NULL,
    file_path TEXT NOT NULL,
    file_size INTEGER,
    image_width INTEGER,
    image_height INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1
);
```

#### products - 产品表
```sql
CREATE TABLE products (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    category_id INTEGER,
    image_path TEXT,
    depth_map_path TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1
);
```

#### access_codes - 授权码表
```sql
CREATE TABLE access_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code TEXT UNIQUE NOT NULL,
    description TEXT,
    start_date DATE,
    end_date DATE,
    max_uses INTEGER,
    used_count INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### users - 用户表
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    is_admin BOOLEAN DEFAULT 0,
    permissions TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1
);
```

#### access_logs - 访问日志表
```sql
CREATE TABLE access_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT UNIQUE NOT NULL,
    access_code TEXT NOT NULL,
    ip_address TEXT,
    location TEXT,
    browser TEXT,
    operating_system TEXT,
    login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    logout_time TIMESTAMP,
    last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1
);
```

## 功能模块

### 1. 授权码访问控制
- **功能**: 通过授权码控制前台访问权限
- **特点**: 支持有效期、使用次数限制
- **会话管理**: 自动记录用户访问日志和活动状态

### 2. 印花图案管理
- **上传**: 支持图片文件上传和预览
- **管理**: 图案列表查看、删除、批量清空
- **存储**: 自动生成文件名和路径管理

### 3. 产品管理
- **产品图片**: 支持产品图片上传
- **深度图**: 配置产品的深度图信息
- **分类**: 产品分类管理

### 4. 用户权限管理
- **管理员**: 拥有所有权限
- **普通用户**: 基于权限配置的功能访问
- **权限类型**: pattern_manage, product_manage等

## 部署和运行

### 环境要求
```
Python 3.7+
Flask
Gradio
Pillow
SQLite3
```

### 安装依赖
```bash
pip install -r requirements.txt
```

### 启动应用

#### 启动前台应用
```bash
python app.py
# 访问地址: http://localhost:5000
```

#### 启动后台管理
```bash
python admin_app.py
# 访问地址: http://localhost:7860
```

### 默认账户信息
- **管理员账号**: admin
- **管理员密码**: admin123
- **测试授权码**: TEST2024

## 开发指南

### 添加新功能模块

1. **后端API**: 在`frontend/api.py`中添加新的路由
2. **数据模型**: 在`backend/models.py`中定义数据结构
3. **数据库操作**: 在`backend/database.py`中添加数据库方法
4. **前端界面**: 在`templates/`中创建HTML模板
5. **样式文件**: 在`static/css/`中添加样式
6. **JavaScript**: 在`static/js/`中添加交互逻辑

### 数据库迁移
- 修改`backend/database.py`中的`init_database()`函数
- 添加新表或字段的创建语句
- 重启应用自动执行迁移

### 权限控制
- 在`backend/auth.py`中定义新的权限类型
- 在相关功能中使用`check_permission()`验证权限
- 在用户创建时分配相应权限

## 安全考虑

1. **密码安全**: 使用bcrypt进行密码哈希
2. **会话管理**: 自动过期和强制登出功能
3. **文件上传**: 限制文件类型和大小
4. **SQL注入**: 使用参数化查询
5. **授权验证**: 每个请求都验证授权状态

## 性能优化

1. **文件缓存**: 静态文件使用浏览器缓存
2. **数据库索引**: 关键字段添加索引
3. **图片压缩**: 上传图片自动压缩处理
4. **会话清理**: 定期清理过期会话数据

## 故障排除

### 常见问题

1. **数据库锁定**: 重启应用释放数据库连接
2. **文件上传失败**: 检查uploads目录权限
3. **授权码无效**: 检查数据库中授权码状态
4. **端口占用**: 修改app.py和admin_app.py中的端口配置

### 日志查看
- 应用日志: 控制台输出
- 访问日志: 数据库access_logs表
- 错误日志: Python异常堆栈

## 扩展建议

1. **云存储**: 集成阿里云OSS或腾讯云COS
2. **用户注册**: 添加用户自助注册功能
3. **API文档**: 使用Swagger生成API文档
4. **监控告警**: 集成应用性能监控
5. **多语言**: 添加国际化支持
6. **移动端**: 开发响应式移动端界面

---

*文档版本: v1.0.0*  
*更新时间: 2025-01-15*  
*维护人员: 开发团队*